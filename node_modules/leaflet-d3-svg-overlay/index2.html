<!DOCTYPE html>
<html>
<head>
    <title>L.D3SvgOverlay: Leaflet + D3, simple example</title>

    <style type="text/css">
        html { height: 100% }
        body { height: 100%; margin: 0; padding: 0 }
        #map-canvas { height: 100% }
    </style>
    <link href='https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.0.0-beta.1/leaflet.css'
          rel='stylesheet' type='text/css'/>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge">

</head>
<body>
<div id="map-canvas"></div>

<!--<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.5/leaflet-src.js"></script>-->
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.0.0-beta.1/leaflet-src.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.4.9/d3.min.js"></script>
<script src="./L.D3SvgOverlay.js?2"></script>
<script>

    // Remove rounding in Leaflet:
    //L.Point.prototype._round = function(){return this;};

    var map = L.map("map-canvas",{center:[46.81509864599243, 8.3221435546875],zoom:8});
    L.tileLayer('http://otile{s}.mqcdn.com/tiles/1.0.0/map/{z}/{x}/{y}.jpeg', {
        attribution: 'Tiles Courtesy of <a href="http://www.mapquest.com/">MapQuest</a> '
                +'&mdash; Map data &copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>',
        subdomains: '1234'
    }).addTo(map);
    var cities = [];
    var citiesOverlay = L.d3SvgOverlay(function(sel,proj){

        var _this = this;
        var minLogPop = Math.log2(d3.min(cities,function(d){return d.population;}));
        var citiesUpd = sel.selectAll('circle').data(cities);
        citiesUpd.enter()
                .append('circle')
                .attr('cx',function(d){return map.latLngToLayerPoint(d.latLng).x;})
                .attr('cy',function(d){return map.latLngToLayerPoint(d.latLng).y;})

                .attr('stroke','black')
                .attr('fill',function(d){return (d.place == 'city') ? "red" : "blue";});
        citiesUpd
                .attr('r',function(d){return (Math.log2(d.population) - minLogPop + 2)})
                .attr('stroke-width',1)
    });
    d3.csv("swiss-cities.csv",function(data){
        cities = data.map(function(d){
            d.latLng = [+d.lat,+d.lng];
            d.population = (d.population == '') ? 2000 : +d.population; //NAs
            return d;
        });
        //citiesOverlay.addTo(map);
        //citiesOverlay2.addTo(map);
    });

    map.on("click", function(evt) {
        console.log(evt);
        L.circle(evt.latlng, 5000).addTo(map);
    });


    var citiesOverlay2 = L.d3SvgOverlay(function(sel,proj){

        var _this = this;
        var minLogPop = Math.log2(d3.min(cities,function(d){return d.population;}));
        var citiesUpd = sel.selectAll('circle').data(cities);
        citiesUpd.enter()
                .append('circle')
                .attr('cx',function(d){return map.latLngToLayerPoint(d.latLng).x;})
                .attr('cy',function(d){return map.latLngToLayerPoint(d.latLng).y;})

                .attr('stroke','black')
                .attr('fill',function(d){return (d.place == 'city') ? "red" : "blue";});
        citiesUpd
                .attr('r',function(d){return (Math.log2(d.population) - minLogPop + 2)})
                .attr('stroke-width',1)
    });

</script>

</body>
</html>