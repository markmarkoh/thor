<!DOCTYPE html>
<html>
<head>
    <title>L.D3SvgOverlay: Leaflet + D3, simple example</title>

    <style type="text/css">
        html { height: 100% }
        body { height: 100%; margin: 0; padding: 0 }
        #map-canvas { height: 100% }
    </style>
    <link href='https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.5/leaflet.css'
          rel='stylesheet' type='text/css'/>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge">

</head>
<body>
<div id="map-canvas"></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.5/leaflet-src.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.4.9/d3.min.js"></script>
<script src="../L.D3SvgOverlay.min.js"></script>
<script>
    var map = L.map("map-canvas",{center: [46.81509864599243, 8.3221435546875], zoom: 9});
    L.tileLayer('https://{s}.tiles.mapbox.com/v3/teralytic.l9n5k164/{z}/{x}/{y}.png',{
        maxZoom: 18
    }).addTo(map);
    L.tileLayer('http://otile{s}.mqcdn.com/tiles/1.0.0/map/{z}/{x}/{y}.jpeg', {
        attribution: 'Tiles Courtesy of <a href="http://www.mapquest.com/">MapQuest</a> '
                +'&mdash; Map data &copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>',
        subdomains: '1234'
    });


    var cities = [];
    d3.csv("swiss-cities.csv", function(data){
        console.log(data.length);
        cities = data.map(function(c){c.latLng = [+c.lat, +c.lng]; return c;});
        svgHeatmap.draw();



    });

    var svgHeatmap = L.d3SvgOverlay(function(papa, proj){

        papa.attr("filter", "url(#hmp)");

        var svgFilter = d3.select(papa.node().parentNode)
                .append("defs")
                .append("filter")
            //.attr("filterUnits","userSpaceOnUse")
                .attr("id","hmp");


        /**/
        svgFilter.append('feGaussianBlur')
                .attr("in","SourceGraphic")
                .attr("stdDeviation", 10);
        /**/


        var grayscale =
                "0 0 0 -1 1\n" +
                        "0 0 0 -1 1\n" +
                        "0 0 0 -1 1\n" +
                        "0 0 0 20 -0.1\n";

        /**/
        svgFilter.append('feColorMatrix')
                .attr('type','matrix')
                .attr('values',grayscale);
        /**/


        /**/
        var colorizer = svgFilter.append('feComponentTransfer');

        colorizer.append('feFuncR')
                .attr("type","table")
                .attr("tableValues","0.66 1 1 0 0");

        colorizer.append('feFuncG')
                .attr("type","table")
                .attr("tableValues","0 0.1 1 1 1");

        colorizer.append('feFuncB')
                .attr("type","table")
                .attr("tableValues","0.01 0 0 0 0 0.1");

        colorizer.append('feFuncA')
                .attr("type","table")
                .attr("tableValues","0 0.4 0.65 0.65 0.65");




       var cityUpdateSelection = papa.selectAll("circle.heatmap").data(cities);
        cityUpdateSelection.enter()
                .append("circle")
                .attr('class','heatmap')
                .attr("stroke-width",0)
                .attr("cx", function(d){return proj.latLngToLayerPoint(d.latLng).x;})
                .attr("cy", function(d){return proj.latLngToLayerPoint(d.latLng).y;})
                .attr("r", function(d){return Math.sqrt(+d.population) / Math.PI * proj.unitsPerMeter * 50;})
                .attr('fill',function(d){return 'rgba(0,0,0,0.5)';});

    });

    svgHeatmap.addTo(map);



    var gSel = svgHeatmap._rootGroup;

    var addHeat = function(overlay) {


    };

    addHeat(svgHeatmap);







</script>
<script src="empty-overlay.js"></script>
</body>
</html>